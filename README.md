## Bay Area Sea Kayakers: A Chart On Every Deck

This repository contains a [QGIS](https://qgis.org) project used to create and maintain nautical charts for the [Bay Area Sea Kayakers (BASK)](https://bask.org) club.

The initial setup of this project was created by [Joe Berkovitz](https://github.com/joeberkovitz).

### Description

The QGIS project `BASK-charts-3.24.qgz` contains data layers, styles, themes and a map layout for producing a set of charts. The layout is controlled by an atlas of chart rectangles which automate the production of an entire set of charts.

### Layers

- **Chart atlas layouts** is based on the GeoJSON file `chartAtlas.geojson`. This contains polygons that drive the production of the atlas. Each polygon should be a rectangle with the same aspect ratio as the map in the **Chart Atlas** layout, in either portrait or landscape orientation. The size of the rectangle should be chosen to yield a map scale in the layout that is approximately the same as the cartographic scale of the main raster charts included.

  - `title`: the title of the chart. This is also used to derive the eventual filename of the exported chart.
  - `inactive`: a boolean that if set will exclude the chart from the atlas. (It still leaves the chart visible in the layer rendering.)
  - `angle`: a floating point angle by which the chart should be rotated from true north. This should be set by hand to *opposite* the angle of the chart rectangle's visual orientation in the layout. If the chart rectangle is rotated 30ยบ from vertical, than the map rotation should be -30ยบ.

- **datapoints w/ label positions** uses the GeoJSON file `datapoint-labels.gpkg` which contains imported Trip Planner datapoints along with nullable label positions.
  -  `latitude`, `longitude`: the position of the data point.
  -  `sid` a unique string associated with the data point by the Trip Planner
  -  `title` the full title of the data point
  -  `chart_title` the title as it should be displayed alongside the data point, or NULL/blank if `title` should be used
  -  `type` the type field from the Trip Planner
  -  `label_x`, `label_y`: the displayed label position, or NULL to let QGIS default the placement of the label.
 
There are two styles associated with this layer called **default** and **nolabels** which are self-explanatory.

When labels are shown, their size is determined by the overall map scale so that they are ultimately drawn on the chart in a size that is comparable to original NOAA feature labels. Labels should always be repositioned with the map scale set appropriately as a label's size affects its render position.

This layout necessarily uses a web mercator projection so that the rotation and orientation math work out correctly, since lat/long units are not consistent between the X and Y directions. Right click and export this layer to save a separate GeoJSON file in the EPSG:4326 projection for use in environments requiring lat/long.

- **Compass roses** uses `CompassRose.geojson` for the location of custom compass roses.
  - most of the fields are autogenerated and should not be edited
  - `Declination` determines the rotation of the compass rose
  - `value` determines the text within the rose
  - `scale` gives the map scale at which the rose is intended to be used.

- **Raster Chart Downloads** is a set of footprints for NOAA raster charts. Use the Identify tool and right-click to download a chart. 1:40K is an optimal scale but go larger if needed.

- **NOAA raster** is a group of raster layers incorporating downloaded NOAA RNCs.

- **NOAA print-on-demand** is a raster layer based on NOAA's online WMS server. It draws much faster than the downloaded NOAA raster charts and with better definition but is not as good for generating the eventual charts.

### Themes

The **Layouts** theme selects layers appropriate for testing and editing layout rectangles.
The **SF Chart Atlas** theme selects layers appropriate for an SF-based atlas.

### Layouts

The **Chart Atlas** layout is an atlas-driven map to produce the charts. For production charts, select the **SF Chart Atlas** theme before exporting.

Recommended export procedure is to export the atlas as PNG images which flattens them to a single layer, then use the ImageMagick `convert` utility to convert them to PDF files.

The map item in the layout is automatically resized to reflect the orientation of the atlas feature

There are two sets of labels and scalebars whose opacity is set to 0% or 100% to hide/show them dependent on the orientation.

### Merging an updated datapoints layer with existing label positions

This procedure creates a new datapoints GeoPackage file based on an imported CSV but retaining any existing label positions that are found in the old datapoints layer.

In your local Python installation the `geopandas` package needs to be installed using `pip3` in order to support GIS operations and I/O.

Download a new `chart_data.csv` file from the Trip Planner. Close the QGIS project and using a command shell in the `TripPlanner/` directory, create a copy of the existing datapoints and then invoke the `importcsv.py` program to merge their label positions with the new CSV:

```
cp ../datapoint-labels.gpkg datapoint-labels-backup.gpkg
python3 importcsv.py chart_data.csv ../datapoint-labels.gpkg datapoint-labels-backup.gpkg
```

Reopen the project.

### Creating a fresh datapoints layer

**NOTE: This discards all existing label positions and starts over.**

Download a new `chart_data.csv` file from the Trip Planner. Close the QGIS project and using a command shell in the `TripPlanner/` directory, invoke the `importcsv.py` program to convert a new CSV to `datapoint-labels.gpkg`:

```
python3 importcsv.py chart_data.csv ../datapoint-labels.gpkg
```

Reopen the project.

